name: llama.cpp Auto Update & Release

on:
  push:
    branches: [ infra/automate-llama-cpp-release ]
  workflow_dispatch:
    inputs:
      llama_cpp_tag:
        description: 'llama.cpp tag to build (e.g., b4500)'
        required: true
        default: 'b4600'

permissions:
  contents: write
  pull-requests: write
  actions: write

env:
  CMAKE_C_COMPILER_LAUNCHER: ccache
  CMAKE_CXX_COMPILER_LAUNCHER: ccache

jobs:
  # ---------------------------------------------------------------------------
  # Stage A: Native Builds
  # ---------------------------------------------------------------------------
  build-android:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        android_abi: [arm64-v8a, x86_64]
    defaults:
      run:
        working-directory: third_party
    steps:
      - uses: actions/checkout@v4
      - name: Fetch llama.cpp
        run: |
          TAG="${{ github.event.inputs.llama_cpp_tag }}"
          if [ -z "$TAG" ] || [ "$TAG" == "latest" ]; then
            TAG=$(curl -s https://api.github.com/repos/ggerganov/llama.cpp/releases/latest | jq -r .tag_name)
          fi
          echo "Selected Tag: $TAG"
          git clone --depth 1 --branch $TAG https://github.com/ggml-org/llama.cpp.git llama_cpp
          git clone --depth 1 https://github.com/KhronosGroup/Vulkan-Headers.git Vulkan-Headers

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Setup Android NDK
        uses: android-actions/setup-android@v3
      - name: Install Ninja & ccache
        run: sudo apt-get update && sudo apt-get install -y ninja-build ccache
      - name: ccache
        uses: ggml-org/ccache-action@v1.2.16
        with:
          key: build-android-${{ matrix.android_abi }}
      - name: Build with Script
        run: ./build_android.sh ${{ matrix.android_abi }}
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: libllamadart_android_${{ matrix.android_abi }}
          path: third_party/bin/android/*/libllamadart.so

  build-apple:
    runs-on: macos-latest
    strategy:
      matrix:
        target: [macos-arm64, macos-x86_64, ios-device-arm64, ios-sim-arm64, ios-sim-x86_64]
    defaults:
      run:
        working-directory: third_party
    steps:
      - uses: actions/checkout@v4
      - name: Fetch llama.cpp
        run: |
          TAG="${{ github.event.inputs.llama_cpp_tag }}"
          if [ -z "$TAG" ] || [ "$TAG" == "latest" ]; then
            TAG=$(curl -s https://api.github.com/repos/ggerganov/llama.cpp/releases/latest | jq -r .tag_name)
          fi
          echo "Selected Tag: $TAG"
          git clone --depth 1 --branch $TAG https://github.com/ggml-org/llama.cpp.git llama_cpp
          git clone --depth 1 https://github.com/KhronosGroup/Vulkan-Headers.git Vulkan-Headers

      - name: Install dependencies
        run: brew install ccache
      - name: ccache
        uses: ggml-org/ccache-action@v1.2.16
        with:
          key: build-apple-${{ matrix.target }}
      - name: Build Apple Target
        run: ./build_apple.sh ${{ matrix.target }}
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: libllamadart_apple_${{ matrix.target }}
          path: |
            third_party/bin/macos/**/*.a
            third_party/bin/macos/**/*.dylib
            third_party/bin/ios/*.a
            third_party/bin/ios/*.dylib

  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        config: [{backend: vulkan, arch: x64}, {backend: cpu, arch: arm64}]
    defaults:
      run:
        working-directory: third_party
    steps:
      - uses: actions/checkout@v4
      - name: Fetch llama.cpp
        run: |
          TAG="${{ github.event.inputs.llama_cpp_tag }}"
          if [ -z "$TAG" ] || [ "$TAG" == "latest" ]; then
            TAG=$(curl -s https://api.github.com/repos/ggerganov/llama.cpp/releases/latest | jq -r .tag_name)
          fi
          echo "Selected Tag: $TAG"
          git clone --depth 1 --branch $TAG https://github.com/ggml-org/llama.cpp.git llama_cpp
          git clone --depth 1 https://github.com/KhronosGroup/Vulkan-Headers.git Vulkan-Headers

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libvulkan-dev glslc ccache ninja-build
          if [ "${{ matrix.config.arch }}" == "arm64" ]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          fi
      - name: ccache
        uses: ggml-org/ccache-action@v1.2.16
        with:
          key: build-linux-${{ matrix.config.arch }}-${{ matrix.config.backend }}
      - name: Build Linux
        run: ./build_linux.sh ${{ matrix.config.backend }} ${{ matrix.config.arch }}
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: libllamadart_linux_${{ matrix.config.arch }}
          path: third_party/bin/linux/${{ matrix.config.arch }}/libllamadart.so

  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        working-directory: third_party
    steps:
      - uses: actions/checkout@v4
      - name: Fetch llama.cpp
        shell: bash
        run: |
          TAG=${{ github.event.inputs.llama_cpp_tag }}
          if [ "$TAG" == "latest" ]; then
            TAG=$(curl -s https://api.github.com/repos/ggerganov/llama.cpp/releases/latest | jq -r .tag_name)
          fi
          git clone --depth 1 --branch $TAG https://github.com/ggml-org/llama.cpp.git llama_cpp
          git clone --depth 1 https://github.com/KhronosGroup/Vulkan-Headers.git Vulkan-Headers
      - name: Install dependencies (ccache, ninja)
        run: choco install ccache ninja -y
      - name: ccache
        uses: ggml-org/ccache-action@v1.2.16
        with:
          key: windows-vulkan
      - name: Install Vulkan SDK
        run: |
          $ver = "1.4.313.2"
          curl.exe -o $env:RUNNER_TEMP/VulkanSDK-Installer.exe -L "https://sdk.lunarg.com/sdk/download/$ver/windows/vulkansdk-windows-X64-$ver.exe"
          & "$env:RUNNER_TEMP\VulkanSDK-Installer.exe" --accept-licenses --default-answer --confirm-command install
          Add-Content $env:GITHUB_ENV "VULKAN_SDK=C:\VulkanSDK\$ver"
          Add-Content $env:GITHUB_PATH "C:\VulkanSDK\$ver\Bin"
      - name: Build Windows
        run: .\build_windows.ps1 vulkan
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: libllamadart_windows_x64
          path: third_party/bin/windows/x64/libllamadart.dll

  # ---------------------------------------------------------------------------
  # Stage B: Code Generation (Bindings & Hooks)
  # ---------------------------------------------------------------------------
  codegen:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - name: Fetch llama.cpp for Headers
        id: tag
        run: |
          TAG="${{ github.event.inputs.llama_cpp_tag }}"
          if [ -z "$TAG" ] || [ "$TAG" == "latest" ]; then
            TAG=$(curl -s https://api.github.com/repos/ggerganov/llama.cpp/releases/latest | jq -r .tag_name)
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          git clone --depth 1 --branch $TAG https://github.com/ggml-org/llama.cpp.git third_party/llama_cpp
      - name: Install LLVM
        run: sudo apt-get update && sudo apt-get install -y libllvm15 libclang-15-dev
      - name: Run ffigen
        run: |
          flutter pub get
          dart run ffigen
      - name: Update hook/build.dart
        run: |
          TAG=${{ steps.tag.outputs.tag }}
          sed -i "s/const _llamaCppTag = '.*';/const _llamaCppTag = '$TAG';/" hook/build.dart
      - name: Upload Generated Code
        uses: actions/upload-artifact@v4
        with:
          name: updated_source
          path: |
            lib/src/generated/llama_bindings.dart
            hook/build.dart

  # ---------------------------------------------------------------------------
  # Stage C: Verification (Desktop & Mobile)
  # ---------------------------------------------------------------------------
  test-desktop:
    needs: [build-linux, build-apple, build-windows, codegen]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - name: Download Updated Source
        uses: actions/download-artifact@v4
        with:
          name: updated_source
          path: .
      - name: Download Binaries
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Cache Test Model
        uses: actions/cache@v4
        with:
          path: models
          key: test-model-stories15M
      - name: Prepare Binaries for Hook
        shell: bash
        run: |
          mkdir -p third_party/bin/linux/x64
          mkdir -p third_party/bin/macos/arm64
          mkdir -p third_party/bin/macos/x64
          mkdir -p third_party/bin/windows/x64

          # Linux
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            find artifacts/libllamadart_linux_x64 -name "libllamadart.so" -exec cp {} third_party/bin/linux/x64/libllamadart-linux-x64.so \;
          fi
          # macOS
          if [[ "${{ runner.os }}" == "macOS" ]]; then
            ARCH=$(uname -m)
            # Standardize arch name for hook (x86_64 -> x64)
            HOOK_ARCH=$ARCH
            if [ "$ARCH" == "x86_64" ]; then HOOK_ARCH="x64"; fi
            
            mkdir -p "third_party/bin/macos/$HOOK_ARCH"
            if [ "$ARCH" == "arm64" ]; then
              find artifacts/libllamadart_apple_macos-arm64 -name "libllamadart.dylib" -exec cp {} third_party/bin/macos/arm64/libllamadart-macos-arm64.dylib \;
            else
              find artifacts/libllamadart_apple_macos-x86_64 -name "libllamadart.dylib" -exec cp {} third_party/bin/macos/x64/libllamadart-macos-x86_64.dylib \;
            fi
          fi
          # Windows
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            find artifacts/libllamadart_windows_x64 -name "libllamadart.dll" -exec cp {} third_party/bin/windows/x64/libllamadart-windows-x64.dll \;
          fi
          
          # Debug: List prepared files
          ls -R third_party/bin
      - name: Run Tests
        shell: bash
        run: |
          flutter pub get
          # Download model if not cached
          mkdir -p models
          if [ ! -f "models/stories15M.gguf" ]; then
            curl -L https://huggingface.co/ggml-org/tiny-llamas/resolve/main/stories15M.gguf -o models/stories15M.gguf
          fi
          dart test --concurrency=1

  test-android:
    needs: [build-android, codegen]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - name: Download Updated Source
        uses: actions/download-artifact@v4
        with:
          name: updated_source
          path: .
      - name: Download Android Binaries
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Prepare Android Binaries
        run: |
          mkdir -p third_party/bin/android/arm64
          mkdir -p third_party/bin/android/x64
          find artifacts/libllamadart_android_arm64-v8a -name "libllamadart.so" -exec cp {} third_party/bin/android/arm64/libllamadart-android-arm64.so \;
          find artifacts/libllamadart_android_x86_64 -name "libllamadart.so" -exec cp {} third_party/bin/android/x64/libllamadart-android-x64.so \;
      - name: Run Android Integration Test
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          arch: x86_64
          target: default
          profile: Pixel_3a
          script: |
            flutter pub get
            # Download model
            mkdir -p models
            curl -L https://huggingface.co/ggml-org/tiny-llamas/resolve/main/stories15M.gguf -o models/stories15M.gguf
            # Integration tests are now in integration_test/
            flutter test integration_test/smoke_test.dart

  test-ios:
    needs: [build-apple, codegen]
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - name: Download Updated Source
        uses: actions/download-artifact@v4
        with:
          name: updated_source
          path: .
      - name: Download iOS Binaries
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Prepare iOS Binaries
        run: |
          mkdir -p third_party/bin/ios
          find artifacts/libllamadart_apple_ios-sim-arm64 -name "libllamadart-ios-arm64-sim.dylib" -exec cp {} third_party/bin/ios/libllamadart-ios-arm64-sim.dylib \;
          find artifacts/libllamadart_apple_ios-sim-x86_64 -name "libllamadart-ios-x86_64-sim.dylib" -exec cp {} third_party/bin/ios/libllamadart-ios-x86_64-sim.dylib \;
      - name: Run iOS Integration Test
        run: |
          flutter pub get
          # Download model
          mkdir -p models
          curl -L https://huggingface.co/ggml-org/tiny-llamas/resolve/main/stories15M.gguf -o models/stories15M.gguf
          # Start a standard simulator
          # We pick the first available iPhone simulator
          ID=$(xcrun simctl list devices iPhone available --json | jq -r '.devices[] | .[] | .udid' | head -n 1)
          if [ -z "$ID" ]; then
            echo "No available iPhone simulator found!"
            exit 1
          fi
          echo "Booting simulator $ID"
          xcrun simctl boot "$ID" || true
          flutter test integration_test/smoke_test.dart -d "$ID"


  # ---------------------------------------------------------------------------
  # Stage D: Release & PR
  # ---------------------------------------------------------------------------
  release:
    needs: [test-desktop, test-android, test-ios, codegen]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Download Updated Source
        uses: actions/download-artifact@v4
        with:
          name: updated_source
          path: .
      - name: Prepare Release Assets
        run: |
          mkdir -p release_assets
          # Windows
          find artifacts/libllamadart_windows_x64 -name "*.dll" -exec cp {} release_assets/libllamadart-windows-x64.dll \;
          # Linux
          find artifacts/libllamadart_linux_x64 -name "*.so" -exec cp {} release_assets/libllamadart-linux-x64.so \;
          find artifacts/libllamadart_linux_arm64 -name "*.so" -exec cp {} release_assets/libllamadart-linux-arm64.so \;
          # macOS
          find artifacts/libllamadart_apple_macos-arm64 -name "*.a" -exec cp {} release_assets/libllamadart-macos-arm64.a \;
          find artifacts/libllamadart_apple_macos-arm64 -name "*.dylib" -exec cp {} release_assets/libllamadart-macos-arm64.dylib \;
          find artifacts/libllamadart_apple_macos-x86_64 -name "*.a" -exec cp {} release_assets/libllamadart-macos-x86_64.a \;
          find artifacts/libllamadart_apple_macos-x86_64 -name "*.dylib" -exec cp {} release_assets/libllamadart-macos-x86_64.dylib \;
          # iOS
          find artifacts/libllamadart_apple_ios-device-arm64 -name "*.a" -exec cp {} release_assets/ \;
          find artifacts/libllamadart_apple_ios-device-arm64 -name "*.dylib" -exec cp {} release_assets/ \;
          find artifacts/libllamadart_apple_ios-sim-arm64 -name "*.a" -exec cp {} release_assets/ \;
          find artifacts/libllamadart_apple_ios-sim-arm64 -name "*.dylib" -exec cp {} release_assets/ \;
          find artifacts/libllamadart_apple_ios-sim-x86_64 -name "*.a" -exec cp {} release_assets/ \;
          find artifacts/libllamadart_apple_ios-sim-x86_64 -name "*.dylib" -exec cp {} release_assets/ \;
          # Android
          find artifacts/libllamadart_android_arm64-v8a -name "*.so" -exec cp {} release_assets/libllamadart-android-arm64.so \;
          find artifacts/libllamadart_android_x86_64 -name "*.so" -exec cp {} release_assets/libllamadart-android-x64.so \;
          ls -R release_assets
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.codegen.outputs.tag }}
          files: release_assets/*
          draft: false
          prerelease: false
      - name: Cleanup Old Automation PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          OLD_PRS=$(gh pr list --label "automation/llama-cpp" --json number --jq '.[].number')
          for PR in $OLD_PRS; do
            gh pr close $PR --comment "Superseded by version ${{ needs.codegen.outputs.tag }}"
          done
      - name: Create Pull Request for Code Updates
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update llama.cpp to ${{ needs.codegen.outputs.tag }}"
          title: "chore: update llama.cpp to ${{ needs.codegen.outputs.tag }}"
          body: |
            Automated update of llama.cpp to version `${{ needs.codegen.outputs.tag }}`.
            
            - Regenerated FFI bindings.
            - Updated build hook version.
            - Verified on Desktop and Mobile.
          branch: automation/llama-cpp-${{ needs.codegen.outputs.tag }}
          labels: automation/llama-cpp
