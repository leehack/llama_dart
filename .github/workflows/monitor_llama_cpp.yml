name: Monitor llama.cpp

on:
  schedule:
    - cron: '0 */6 * * *' # Every 6 hours
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  actions: write

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.check.outputs.new_tag }}
      should_trigger: ${{ steps.check.outputs.should_trigger }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for new llama.cpp release
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get latest tag from llama.cpp
          LATEST_TAG=$(gh api repos/ggerganov/llama.cpp/releases/latest --jq '.tag_name')
          echo "Latest llama.cpp tag: $LATEST_TAG"

          # Check if we already have a release for this tag
          if gh release view "$LATEST_TAG" > /dev/null 2>&1; then
            echo "Release $LATEST_TAG already exists in our repo. Skipping."
            echo "should_trigger=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Also check if a PR for this tag is already open to avoid duplicates
          OPEN_PR=$(gh pr list --label "automation/llama-cpp" --state open --search "$LATEST_TAG in:title" --json number --jq '.[0].number')
          if [ -n "$OPEN_PR" ]; then
            echo "New version $LATEST_TAG detected but PR #$OPEN_PR is already open."
            echo "should_trigger=false" >> $GITHUB_OUTPUT
          else
            echo "New version $LATEST_TAG detected and no release/PR exists. Triggering build."
            echo "new_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
            echo "should_trigger=true" >> $GITHUB_OUTPUT
          fi

      - name: Trigger Build Workflow
        if: steps.check.outputs.should_trigger == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh workflow run llama_cpp_auto.yml -f llama_cpp_tag=${{ steps.check.outputs.new_tag }}
